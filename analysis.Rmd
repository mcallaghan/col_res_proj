---
title: "analysis_work"
author: "Max Callaghan"
date: "December 2, 2015"
output: html_document
---

```{r warning=FALSE,message=FALSE,cache=TRUE,echo=FALSE}

load("data/merged_corpus_europe.rda")

library(knitr)
library(dplyr)
library(rworldmap)
library(ggmap)
pkgs <- c('twitteR', 'tm.lexicon.GeneralInquirer', 'tm.plugin.sentiment', 'dplyr', 'ggplot2', 'stringr', 'wordcloud', 'tm', 'rworldmap', 'ggmap','ggvis','googleVis')
library(ggvis)
library(googleVis)

spacetime <- function(df,q) {
  df <- df %>%
  filter(query==q) %>%
  group_by(approx_country) %>%
  summarise(
    p1 = mean(stotal[period=="2010"],na.rm=TRUE),
    p2 = mean(stotal[period=="2012"],na.rm=TRUE),
    p3 = mean(stotal[period=="2015"],na.rm=TRUE)
  ) 
  return(df)
}



print(unique(merged_corpus_europe$query))

merkel <- spacetime(merged_corpus_europe,"merkel+greece")

kable(merkel,digits=2)

crisis <- spacetime(merged_corpus_europe,"greece+crisis")

kable(crisis,digits=2)

imf <- spacetime(merged_corpus_europe,"imf+greece")

kable(imf,digits=2)

schauble <- spacetime(merged_corpus_europe,"schäuble+greece")

kable(schauble,digits=2)

austerity <- spacetime(merged_corpus_europe,"austerity+greece")

kable(austerity,digits=2)

geo_corpus <- merged_corpus_europe %>%
  filter(!is.na(latitude))

map_eu <- get_map(zoom = 4, location= "Europe")
mapPoints <- ggmap(map_eu) +
  geom_point(aes(x = longtitude, y = latitude, colour = query),size=1.8, data = geo_corpus) +
  geom_jitter()
mapPoints

by_country_by_year <- merged_corpus_europe %>%
  group_by(approx_country,period) %>%
  summarise(
    germany_greece = mean(stotal[query=="germany+greece"],na.rm=TRUE)
  )


```

We compare each tweet with a lexicon of words categorised as expressing positive and negative sentiment. Each tweet gets a score according to how many positive words it has and how many negative.

## IMF + GREECE

```{r warning=FALSE,message=FALSE,cache=TRUE,echo=FALSE}

library(dplyr)
library(tidyr)
library(lfe)
library(maptools)
library(rgeos)

library(nlme)

countries <- readShapeSpatial("data/geographic_data/CNTR_2014_60M_SH/Data/CNTR_RG_60M_2014.shp")

#countries@data$id <- countries@data$CNTR_ID
countries.points <- fortify(countries)
countries.points <- left_join(
  countries.points,
  data.frame(
    id = unique(countries.points$id),
    CNTR_ID = unique(countries@data$CNTR_ID)
  )
)
countries.df <- countries.points %>%
  left_join(countries@data,by="CNTR_ID")

countries.df$CNTR_ID <- as.character(countries.df$CNTR_ID)

countries.df[countries.df$CNTR_ID=="UK","CNTR_ID"] <- "GB"
countries.df[countries.df$CNTR_ID=="EL","CNTR_ID"] <- "GR"

countries.df <- countries.df %>%
  left_join(
    rename(
      imf,
      CNTR_ID = approx_country
      )
  ) 

ggplot(countries.df) +
  aes(long,lat,group=group,fill=p1) +
  scale_fill_gradientn(colours=c("red","white","green"),limits=c(-2,2)) +
  geom_polygon() +
  #scale_fill_continuous(low="white",high="green",na.value="grey") +
  geom_path(color="grey",size=0.1) +
  #theme_bw() +
  #theme_nothing() +
  theme(
    panel.background = element_rect(fill="#84C9F8"),
    axis.text = element_blank(),
    line = element_blank(),
    axis.text = element_blank()
  ) +
  xlim(c(-12,35)) +
  ylim(c(32,72)) +
  labs(fill="Sentiment",x="",y="") + 
  coord_equal()

ggplot(countries.df) +
  aes(long,lat,group=group,fill=p2) +
  scale_fill_gradientn(colours=c("red","white","green"),limits=c(-2,2)) +
  geom_polygon() +
  #scale_fill_continuous(low="white",high="green",na.value="grey") +
  geom_path(color="grey",size=0.1) +
  #theme_bw() +
  #theme_nothing() +
  theme(
    panel.background = element_rect(fill="#84C9F8"),
    axis.text = element_blank(),
    line = element_blank(),
    axis.text = element_blank()
  ) +
  xlim(c(-12,35)) +
  ylim(c(32,72)) +
  labs(fill="Sentiment",x="",y="") + 
  coord_equal()

ggplot(countries.df) +
  aes(long,lat,group=group,fill=p3) +
  scale_fill_gradientn(colours=c("red","white","green"),limits=c(-2,2)) +
  geom_polygon() +
  #scale_fill_continuous(low="white",high="green",na.value="grey") +
  geom_path(color="grey",size=0.1) +
  #theme_bw() +
  #theme_nothing() +
  theme(
    panel.background = element_rect(fill="#84C9F8"),
    axis.text = element_blank(),
    line = element_blank(),
    axis.text = element_blank()
  ) +
  xlim(c(-12,35)) +
  ylim(c(32,72)) +
  labs(fill="Sentiment",x="",y="") + 
  coord_equal()


```

## Austerity + Greece

```{r warning=FALSE,message=FALSE,cache=TRUE,echo=FALSE}

countries.df <- countries.points %>%
  left_join(countries@data,by="CNTR_ID")

countries.df$CNTR_ID <- as.character(countries.df$CNTR_ID)

countries.df[countries.df$CNTR_ID=="UK","CNTR_ID"] <- "GB"
countries.df[countries.df$CNTR_ID=="EL","CNTR_ID"] <- "GR"

countries.df <- countries.df %>%
  left_join(
    rename(
      austerity,
      CNTR_ID = approx_country
      )
  )

ggplot(countries.df) +
  aes(long,lat,group=group,fill=p1) +
  scale_fill_gradientn(colours=c("red","white","green"),limits=c(-2,2)) +
  geom_polygon() +
  #scale_fill_continuous(low="white",high="green",na.value="grey") +
  geom_path(color="grey",size=0.1) +
  #theme_bw() +
  #theme_nothing() +
  theme(
    panel.background = element_rect(fill="#84C9F8"),
    axis.text = element_blank(),
    line = element_blank(),
    axis.text = element_blank()
  ) +
  xlim(c(-12,35)) +
  ylim(c(32,72)) +
  labs(fill="Sentiment",x="",y="") + 
  coord_equal()

ggplot(countries.df) +
  aes(long,lat,group=group,fill=p2) +
  scale_fill_gradientn(colours=c("red","white","green"),limits=c(-2,2)) +
  geom_polygon() +
  #scale_fill_continuous(low="white",high="green",na.value="grey") +
  geom_path(color="grey",size=0.1) +
  #theme_bw() +
  #theme_nothing() +
  theme(
    panel.background = element_rect(fill="#84C9F8"),
    axis.text = element_blank(),
    line = element_blank(),
    axis.text = element_blank()
  ) +
  xlim(c(-12,35)) +
  ylim(c(32,72)) +
  labs(fill="Sentiment",x="",y="") + 
  coord_equal()

ggplot(countries.df) +
  aes(long,lat,group=group,fill=p3) +
  scale_fill_gradientn(colours=c("red","white","green"),limits=c(-2,2)) +
  geom_polygon() +
  #scale_fill_continuous(low="white",high="green",na.value="grey") +
  geom_path(color="grey",size=0.1) +
  #theme_bw() +
  #theme_nothing() +
  theme(
    panel.background = element_rect(fill="#84C9F8"),
    axis.text = element_blank(),
    line = element_blank(),
    axis.text = element_blank()
  ) +
  xlim(c(-12,35)) +
  ylim(c(32,72)) +
  labs(fill="Sentiment",x="",y="") + 
  coord_equal()

```

## Schäuble + Greece

```{r warning=FALSE,message=FALSE,cache=TRUE,echo=FALSE}

countries.df <- countries.points %>%
  left_join(countries@data,by="CNTR_ID")

countries.df$CNTR_ID <- as.character(countries.df$CNTR_ID)

countries.df[countries.df$CNTR_ID=="UK","CNTR_ID"] <- "GB"
countries.df[countries.df$CNTR_ID=="EL","CNTR_ID"] <- "GR"

countries.df <- countries.df %>%
  left_join(
    rename(
      schauble,
      CNTR_ID = approx_country
      )
  )

ggplot(countries.df) +
  aes(long,lat,group=group,fill=p1) +
  scale_fill_gradientn(colours=c("red","white","green"),limits=c(-2,2)) +
  geom_polygon() +
  #scale_fill_continuous(low="white",high="green",na.value="grey") +
  geom_path(color="grey",size=0.1) +
  #theme_bw() +
  #theme_nothing() +
  theme(
    panel.background = element_rect(fill="#84C9F8"),
    axis.text = element_blank(),
    line = element_blank(),
    axis.text = element_blank()
  ) +
  xlim(c(-12,35)) +
  ylim(c(32,72)) +
  labs(fill="Sentiment",x="",y="") + 
  coord_equal()

ggplot(countries.df) +
  aes(long,lat,group=group,fill=p2) +
  scale_fill_gradientn(colours=c("red","white","green"),limits=c(-2,2)) +
  geom_polygon() +
  #scale_fill_continuous(low="white",high="green",na.value="grey") +
  geom_path(color="grey",size=0.1) +
  #theme_bw() +
  #theme_nothing() +
  theme(
    panel.background = element_rect(fill="#84C9F8"),
    axis.text = element_blank(),
    line = element_blank(),
    axis.text = element_blank()
  ) +
  xlim(c(-12,35)) +
  ylim(c(32,72)) +
  labs(fill="Sentiment",x="",y="") + 
  coord_equal()

ggplot(countries.df) +
  aes(long,lat,group=group,fill=p3) +
  scale_fill_gradientn(colours=c("red","white","green"),limits=c(-2,2)) +
  geom_polygon() +
  #scale_fill_continuous(low="white",high="green",na.value="grey") +
  geom_path(color="grey",size=0.1) +
  #theme_bw() +
  #theme_nothing() +
  theme(
    panel.background = element_rect(fill="#84C9F8"),
    axis.text = element_blank(),
    line = element_blank(),
    axis.text = element_blank()
  ) +
  xlim(c(-12,35)) +
  ylim(c(32,72)) +
  labs(fill="Sentiment",x="",y="") + 
  coord_equal()

```
